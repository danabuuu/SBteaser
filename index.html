import React, { useState, useEffect } from 'react';
import { Trophy, Users, Award, Lock, Eye, EyeOff, LogOut, Settings, RefreshCw } from 'lucide-react';
import { createClient } from '@supabase/supabase-js';

// Replace with your Supabase credentials
const SUPABASE_URL = 'https://eggswgehszlqosxyxfap.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVnZ3N3Z2Voc3pscW9zeHl4ZmFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NjQ2MjAsImV4cCI6MjA4NTA0MDYyMH0.ZGOdzBROuCkjadPvBNdTWVTkGbpZkhZcyhxOI228msI';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

export default function SuperBowlTeaser() {
  const [entries, setEntries] = useState([]);
  const [questions, setQuestions] = useState([]);
  const [correctAnswers, setCorrectAnswers] = useState({});
  const [view, setView] = useState('entry');
  const [isAdminLoggedIn, setIsAdminLoggedIn] = useState(false);
  const [loginForm, setLoginForm] = useState({ username: '', password: '' });
  const [showPassword, setShowPassword] = useState(false);
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    name: '',
    answers: Array(20).fill(null),
    tiebreaker: ''
  });
  const [editingQuestions, setEditingQuestions] = useState(false);

  useEffect(() => {
    loadData();
    
    // Subscribe to realtime changes
    const entriesSubscription = supabase
      .channel('entries-channel')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'entries' }, () => {
        loadEntries();
      })
      .subscribe();

    const answersSubscription = supabase
      .channel('answers-channel')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'correct_answers' }, () => {
        loadCorrectAnswers();
      })
      .subscribe();

    return () => {
      entriesSubscription.unsubscribe();
      answersSubscription.unsubscribe();
    };
  }, []);

  const loadData = async () => {
    await Promise.all([loadEntries(), loadQuestions(), loadCorrectAnswers()]);
  };

  const loadEntries = async () => {
    const { data, error } = await supabase
      .from('entries')
      .select('*')
      .order('created_at', { ascending: true });
    
    if (!error && data) {
      setEntries(data.map(entry => ({
        ...entry,
        answers: bitsToArray(entry.answers_bits)
      })));
    }
  };

  const loadQuestions = async () => {
    const { data, error } = await supabase
      .from('questions')
      .select('questions')
      .eq('id', 1)
      .single();
    
    if (!error && data) {
      setQuestions(data.questions);
    }
  };

  const loadCorrectAnswers = async () => {
    const { data, error } = await supabase
      .from('correct_answers')
      .select('answers_bits, answered_mask')
      .eq('id', 1)
      .single();
    
    if (!error && data) {
      const answers = {};
      for (let i = 0; i < 20; i++) {
        const isAnswered = (data.answered_mask & (1 << i)) !== 0;
        if (isAnswered) {
          answers[i] = (data.answers_bits & (1 << i)) !== 0;
        }
      }
      setCorrectAnswers(answers);
    }
  };

  // Convert array of booleans to 20-bit integer
  const arrayToBits = (arr) => {
    let bits = 0;
    for (let i = 0; i < 20; i++) {
      if (arr[i] === true) {
        bits |= (1 << i);
      }
    }
    return bits;
  };

  // Convert 20-bit integer to array of booleans
  const bitsToArray = (bits) => {
    const arr = [];
    for (let i = 0; i < 20; i++) {
      arr.push((bits & (1 << i)) !== 0);
    }
    return arr;
  };

  const handleLogin = async () => {
    setLoading(true);
    
    // Call Supabase Edge Function to verify credentials
    const { data, error } = await supabase.functions.invoke('verify-admin', {
      body: { username: loginForm.username, password: loginForm.password }
    });

    setLoading(false);

    if (!error && data?.valid) {
      // Sign in with Supabase Auth for session management
      const { error: authError } = await supabase.auth.signInWithPassword({
        email: `${loginForm.username}@admin.local`,
        password: loginForm.password
      });

      if (!authError) {
        setIsAdminLoggedIn(true);
        setView('admin');
        setLoginForm({ username: '', password: '' });
      } else {
        alert('Authentication error');
      }
    } else {
      alert('Invalid credentials');
    }
  };

  const handleLogout = async () => {
    await supabase.auth.signOut();
    setIsAdminLoggedIn(false);
    setView('entry');
  };

  const handleAnswerChange = (index, value) => {
    const newAnswers = [...formData.answers];
    newAnswers[index] = value;
    setFormData({ ...formData, answers: newAnswers });
  };

  const handleSubmit = async () => {
    if (!formData.name || formData.answers.includes(null) || !formData.tiebreaker) {
      alert('Please complete all fields');
      return;
    }
    
    setLoading(true);
    
    const { error } = await supabase
      .from('entries')
      .insert({
        name: formData.name,
        answers_bits: arrayToBits(formData.answers),
        tiebreaker: parseInt(formData.tiebreaker)
      });

    setLoading(false);

    if (!error) {
      setFormData({ name: '', answers: Array(20).fill(null), tiebreaker: '' });
      alert('Entry submitted successfully!');
      loadEntries();
    } else {
      alert('Error submitting entry. Please try again.');
    }
  };

  const handleCorrectAnswerChange = async (index, value) => {
    const { data: current } = await supabase
      .from('correct_answers')
      .select('answers_bits, answered_mask')
      .eq('id', 1)
      .single();

    if (current) {
      let newAnswersBits = current.answers_bits;
      let newAnsweredMask = current.answered_mask;

      if (value === undefined) {
        // Clear this answer
        newAnsweredMask &= ~(1 << index);
        newAnswersBits &= ~(1 << index);
      } else {
        // Set this answer
        newAnsweredMask |= (1 << index);
        if (value) {
          newAnswersBits |= (1 << index);
        } else {
          newAnswersBits &= ~(1 << index);
        }
      }

      const { error } = await supabase
        .from('correct_answers')
        .update({
          answers_bits: newAnswersBits,
          answered_mask: newAnsweredMask
        })
        .eq('id', 1);

      if (!error) {
        loadCorrectAnswers();
      }
    }
  };

  const handleSaveQuestions = async () => {
    setLoading(true);
    
    const { error } = await supabase
      .from('questions')
      .update({ questions })
      .eq('id', 1);

    setLoading(false);

    if (!error) {
      alert('Questions saved successfully!');
      setEditingQuestions(false);
    } else {
      alert('Error saving questions');
    }
  };

  const calculateScore = (entry) => {
    let score = 0;
    entry.answers.forEach((answer, index) => {
      if (correctAnswers[index] !== undefined && correctAnswers[index] === answer) {
        score++;
      }
    });
    return score;
  };

  const calculatePercentages = (questionIndex) => {
    if (entries.length === 0) return { yes: 0, no: 0 };
    const yesCount = entries.filter(e => e.answers[questionIndex] === true).length;
    const noCount = entries.filter(e => e.answers[questionIndex] === false).length;
    return {
      yes: Math.round((yesCount / entries.length) * 100),
      no: Math.round((noCount / entries.length) * 100)
    };
  };

  const getSortedEntries = () => {
    return [...entries].sort((a, b) => calculateScore(b) - calculateScore(a));
  };

  // Entry Form View
  if (view === 'entry') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-blue-800 p-4">
        <div className="max-w-3xl mx-auto">
          <div className="bg-white rounded-lg shadow-2xl p-6 mb-4">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-3">
                <Trophy className="w-8 h-8 text-yellow-500" />
                <h1 className="text-3xl font-bold text-gray-800">Super Bowl Teaser</h1>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={() => setView('scores')}
                  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                >
                  View Scores
                </button>
                <button
                  onClick={() => setView('login')}
                  className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
                >
                  Admin
                </button>
              </div>
            </div>

            <div>
              <div className="mb-6">
                <label className="block text-gray-700 font-semibold mb-2">Your Name</label>
                <input
                  type="text"
                  value={formData.name}
                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Enter your name"
                />
              </div>

              <div className="mb-6">
                <h2 className="text-xl font-bold text-gray-800 mb-4">Answer YES or NO to each question:</h2>
                <div className="space-y-3">
                  {questions.map((question, index) => (
                    <div key={index} className="bg-gray-50 p-4 rounded-lg">
                      <p className="text-gray-700 mb-3">
                        <span className="font-semibold">{index + 1}.</span> {question}
                      </p>
                      <div className="flex gap-4">
                        <label className="flex items-center cursor-pointer">
                          <input
                            type="radio"
                            name={`q${index}`}
                            checked={formData.answers[index] === true}
                            onChange={() => handleAnswerChange(index, true)}
                            className="w-4 h-4 text-green-600"
                          />
                          <span className="ml-2 text-gray-700">YES</span>
                        </label>
                        <label className="flex items-center cursor-pointer">
                          <input
                            type="radio"
                            name={`q${index}`}
                            checked={formData.answers[index] === false}
                            onChange={() => handleAnswerChange(index, false)}
                            className="w-4 h-4 text-red-600"
                          />
                          <span className="ml-2 text-gray-700">NO</span>
                        </label>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="mb-6">
                <label className="block text-gray-700 font-semibold mb-2">
                  Tiebreaker: Total Points Scored in the Game
                </label>
                <input
                  type="number"
                  value={formData.tiebreaker}
                  onChange={(e) => setFormData({ ...formData, tiebreaker: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Enter total points (e.g., 51)"
                  min="0"
                />
              </div>

              <button
                onClick={handleSubmit}
                disabled={loading}
                className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition shadow-lg disabled:opacity-50 flex items-center justify-center gap-2"
              >
                {loading ? (
                  <>
                    <RefreshCw className="w-5 h-5 animate-spin" />
                    Submitting...
                  </>
                ) : (
                  'Submit Entry'
                )}
              </button>
            </div>

            <div className="mt-6 text-center text-gray-600">
              <p className="flex items-center justify-center gap-2">
                <Users className="w-5 h-5" />
                {entries.length} {entries.length === 1 ? 'entry' : 'entries'} submitted
              </p>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Login View
  if (view === 'login') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-blue-800 p-4 flex items-center justify-center">
        <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
          <div className="flex items-center gap-3 mb-6">
            <Lock className="w-8 h-8 text-purple-600" />
            <h1 className="text-2xl font-bold text-gray-800">Admin Login</h1>
          </div>
          
          <div className="space-y-4">
            <div>
              <label className="block text-gray-700 font-semibold mb-2">Username</label>
              <input
                type="text"
                value={loginForm.username}
                onChange={(e) => setLoginForm({ ...loginForm, username: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                placeholder="Enter username"
              />
            </div>
            
            <div>
              <label className="block text-gray-700 font-semibold mb-2">Password</label>
              <div className="relative">
                <input
                  type={showPassword ? 'text' : 'password'}
                  value={loginForm.password}
                  onChange={(e) => setLoginForm({ ...loginForm, password: e.target.value })}
                  onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  placeholder="Enter password"
                />
                <button
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute right-3 top-2.5 text-gray-500 hover:text-gray-700"
                >
                  {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                </button>
              </div>
            </div>
            
            <button
              onClick={handleLogin}
              disabled={loading}
              className="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition disabled:opacity-50 flex items-center justify-center gap-2"
            >
              {loading ? (
                <>
                  <RefreshCw className="w-5 h-5 animate-spin" />
                  Logging in...
                </>
              ) : (
                'Login'
              )}
            </button>
            
            <button
              onClick={() => setView('entry')}
              className="w-full bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition"
            >
              Back to Entry Form
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Admin View
  if (view === 'admin' && isAdminLoggedIn) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-blue-800 p-4">
        <div className="max-w-6xl mx-auto">
          <div className="bg-white rounded-lg shadow-2xl p-6">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-3">
                <Award className="w-8 h-8 text-purple-600" />
                <h1 className="text-3xl font-bold text-gray-800">Admin Panel</h1>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={() => setEditingQuestions(!editingQuestions)}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
                >
                  <Settings className="w-4 h-4" />
                  {editingQuestions ? 'Done Editing' : 'Edit Questions'}
                </button>
                <button
                  onClick={handleLogout}
                  className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center gap-2"
                >
                  <LogOut className="w-4 h-4" />
                  Logout
                </button>
              </div>
            </div>

            {editingQuestions ? (
              <div className="space-y-3 mb-6">
                <h2 className="text-xl font-bold text-gray-800 mb-4">Edit Questions</h2>
                {questions.map((question, index) => (
                  <div key={index} className="flex gap-2">
                    <span className="text-gray-600 font-semibold mt-2">{index + 1}.</span>
                    <input
                      type="text"
                      value={question}
                      onChange={(e) => {
                        const newQuestions = [...questions];
                        newQuestions[index] = e.target.value;
                        setQuestions(newQuestions);
                      }}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                ))}
                <button
                  onClick={handleSaveQuestions}
                  disabled={loading}
                  className="mt-4 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition disabled:opacity-50 flex items-center gap-2"
                >
                  {loading ? (
                    <>
                      <RefreshCw className="w-4 h-4 animate-spin" />
                      Saving...
                    </>
                  ) : (
                    'Save Questions'
                  )}
                </button>
              </div>
            ) : (
              <>
                <h2 className="text-xl font-bold text-gray-800 mb-4">Enter Correct Answers</h2>
                <div className="space-y-3 mb-8">
                  {questions.map((question, index) => (
                    <div key={index} className="bg-gray-50 p-4 rounded-lg">
                      <p className="text-gray-700 mb-3">
                        <span className="font-semibold">{index + 1}.</span> {question}
                      </p>
                      <div className="flex gap-4">
                        <label className="flex items-center cursor-pointer">
                          <input
                            type="radio"
                            name={`correct${index}`}
                            checked={correctAnswers[index] === true}
                            onChange={() => handleCorrectAnswerChange(index, true)}
                            className="w-4 h-4 text-green-600"
                          />
                          <span className="ml-2 text-gray-700 font-semibold">YES</span>
                        </label>
                        <label className="flex items-center cursor-pointer">
                          <input
                            type="radio"
                            name={`correct${index}`}
                            checked={correctAnswers[index] === false}
                            onChange={() => handleCorrectAnswerChange(index, false)}
                            className="w-4 h-4 text-red-600"
                          />
                          <span className="ml-2 text-gray-700 font-semibold">NO</span>
                        </label>
                        <label className="flex items-center cursor-pointer">
                          <input
                            type="radio"
                            name={`correct${index}`}
                            checked={correctAnswers[index] === undefined}
                            onChange={() => handleCorrectAnswerChange(index, undefined)}
                            className="w-4 h-4 text-gray-400"
                          />
                          <span className="ml-2 text-gray-500">Not Yet Answered</span>
                        </label>
                      </div>
                    </div>
                  ))}
                </div>

                <h2 className="text-xl font-bold text-gray-800 mb-4">All Entries</h2>
                {entries.length === 0 ? (
                  <p className="text-gray-600 text-center py-8">No entries yet</p>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="bg-gray-100">
                          <th className="px-3 py-2 text-left">Name</th>
                          <th className="px-3 py-2 text-left">Score</th>
                          <th className="px-3 py-2 text-left">Answers</th>
                          <th className="px-3 py-2 text-left">Tiebreaker</th>
                        </tr>
                      </thead>
                      <tbody>
                        {getSortedEntries().map((entry) => (
                          <tr key={entry.id} className="border-b hover:bg-gray-50">
                            <td className="px-3 py-3 font-semibold">{entry.name}</td>
                            <td className="px-3 py-3 text-lg font-bold text-purple-600">
                              {calculateScore(entry)}
                            </td>
                            <td className="px-3 py-3">
                              <div className="flex gap-1 flex-wrap">
                                {entry.answers.map((ans, i) => (
                                  <span
                                    key={i}
                                    className={`px-1.5 py-0.5 rounded text-xs font-semibold ${
                                      correctAnswers[i] !== undefined && correctAnswers[i] === ans
                                        ? 'bg-green-500 text-white'
                                        : ans
                                        ? 'bg-green-100 text-green-800'
                                        : 'bg-red-100 text-red-800'
                                    }`}
                                  >
                                    {i + 1}:{ans ? 'Y' : 'N'}
                                  </span>
                                ))}
                              </div>
                            </td>
                            <td className="px-3 py-3">{entry.tiebreaker}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </>
            )}
          </div>
        </div>
      </div>
    );
  }

  // Scores View (Public)
  if (view === 'scores') {
    const sortedEntries = getSortedEntries();
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-blue-800 p-4">
        <div className="max-w-7xl mx-auto">
          <div className="bg-white rounded-lg shadow-2xl p-6">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-3">
                <Trophy className="w-8 h-8 text-yellow-500" />
                <h1 className="text-3xl font-bold text-gray-800">Live Scoreboard</h1>
              </div>
              <button
                onClick={() => setView('entry')}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
              >
                Back to Entry Form
              </button>
            </div>

            {entries.length === 0 ? (
              <p className="text-gray-600 text-center py-8">No entries yet</p>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full text-xs">
                  <thead>
                    <tr className="bg-gray-100">
                      <th className="px-2 py-2 text-left sticky left-0 bg-gray-100 z-10">Rank</th>
                      <th className="px-2 py-2 text-left sticky left-12 bg-gray-100 z-10">Name</th>
                      <th className="px-2 py-2 text-center sticky left-32 bg-gray-100 z-10">Score</th>
                      {questions.map((_, i) => (
                        <th key={i} className="px-1 py-2 text-center">
                          <div className="font-bold">{i + 1}</div>
                          <div className="text-xs text-gray-500">
                            {calculatePercentages(i).yes}% Y
                          </div>
                        </th>
                      ))}
                      <th className="px-2 py-2 text-center">TB</th>
                    </tr>
                  </thead>
                  <tbody>
                    {sortedEntries.map((entry, rank) => (
                      <tr key={entry.id} className="border-b hover:bg-gray-50">
                        <td className="px-2 py-2 font-bold sticky left-0 bg-white z-10">
                          {rank + 1}
                        </td>
                        <td className="px-2 py-2 font-semibold sticky left-12 bg-white z-10">
                          {entry.name}
                        </td>
                        <td className="px-2 py-2 text-center font-bold text-lg text-purple-600 sticky left-32 bg-white z-10">
                          {calculateScore(entry)}
                        </td>
                        {entry.answers.map((ans, i) => (
                          <td
                            key={i}
                            className={`px-1 py-2 text-center font-bold ${
                              correctAnswers[i] !== undefined && correctAnswers[i] === ans
                                ? 'bg-green-400 text-white'
                                : ''
                            }`}
                          >
                            {ans ? 'Y' : 'N'}
                          </td>
                        ))}
                        <td className="px-2 py-2 text-center text-gray-600">
                          {entry.tiebreaker}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  return null;
}
